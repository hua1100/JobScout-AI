name: 104 AI Job Scraper

# 觸發條件
on:
  schedule:
    # 每月1號凌晨2點執行 (UTC+8 = 前一天18:00 UTC)
    - cron: '0 18 1 * *'
  
  # 允許手動觸發
  workflow_dispatch:

jobs:
  scrape-jobs:
    runs-on: ubuntu-latest
    
    steps:
    # 1. 取得程式碼
    - name: Checkout repository
      uses: actions/checkout@v3
    
    # 2. 設定Python環境
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    # 3. 安裝依賴套件
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # 4. 執行爬蟲
    - name: Run scraper
      run: |
        echo "開始爬取104職缺..."
        scrapy crawl 104_ai_jobs
        echo "爬取完成!"
    
    # 5. 取得CSV檔案名稱
    - name: Get CSV filename
      id: get_csv
      run: |
        CSV_FILE=$(ls ai_jobs_*.csv 2>/dev/null | tail -1)
        if [ -z "$CSV_FILE" ]; then
          echo "錯誤: 找不到CSV檔案"
          exit 1
        fi
        echo "csv_file=$CSV_FILE" >> $GITHUB_OUTPUT
        echo "找到檔案: $CSV_FILE"
        
        # 計算職缺數量
        JOB_COUNT=$(wc -l < "$CSV_FILE")
        echo "job_count=$JOB_COUNT" >> $GITHUB_OUTPUT
        echo "共找到 $JOB_COUNT 筆職缺"
    
    # 6. 上傳CSV到GitHub Artifacts (方便下載)
    - name: Upload CSV as artifact
      uses: actions/upload-artifact@v3
      with:
        name: job-listings
        path: ${{ steps.get_csv.outputs.csv_file }}
        retention-days: 90
    
    # 7. 建立GitHub Release並上傳檔案
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: scrape-${{ github.run_number }}
        name: 職缺資料 - ${{ github.run_number }}
        body: |
          ## 104 AI職缺爬蟲結果
          
          **執行時間**: ${{ github.event.repository.updated_at }}
          **職缺數量**: ${{ steps.get_csv.outputs.job_count }} 筆
          
          ### 搜尋條件
          - 關鍵字: AI自動化、AI轉型、數位轉型、流程自動化、RPA、AI工程師
          - 地區: 台北市、新北市
          
          點擊下方檔案下載CSV
        files: ${{ steps.get_csv.outputs.csv_file }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # 8. 觸發Make.com Webhook (如果有設定)
    - name: Trigger Make.com Webhook
      if: ${{ secrets.MAKE_WEBHOOK_URL != '' }}
      run: |
        curl -X POST "${{ secrets.MAKE_WEBHOOK_URL }}" \
          -H "Content-Type: application/json" \
          -d '{
            "status": "success",
            "file_url": "${{ steps.create_release.outputs.upload_url }}",
            "download_url": "https://github.com/${{ github.repository }}/releases/download/scrape-${{ github.run_number }}/${{ steps.get_csv.outputs.csv_file }}",
            "job_count": "${{ steps.get_csv.outputs.job_count }}",
            "run_number": "${{ github.run_number }}",
            "timestamp": "${{ github.event.repository.updated_at }}"
          }'
        echo "✓ Make.com Webhook已觸發"
    
    # 9. 執行摘要
    - name: Job Summary
      run: |
        echo "## 🎉 執行結果" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ 爬取成功" >> $GITHUB_STEP_SUMMARY
        echo "- 📊 職缺數量: ${{ steps.get_csv.outputs.job_count }} 筆" >> $GITHUB_STEP_SUMMARY
        echo "- 📁 檔案: ${{ steps.get_csv.outputs.csv_file }}" >> $GITHUB_STEP_SUMMARY
        echo "- 🔗 [下載連結](https://github.com/${{ github.repository }}/releases/tag/scrape-${{ github.run_number }})" >> $GITHUB_STEP_SUMMARY
